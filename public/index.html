{% extends "app.html" %}
{% block title %}Chat â€“ Home{% endblock %}
{% block content %}
<div class="row g-3">
  <div class="col-3">
    <h5 class="mb-3">Rooms</h5>
    <ul id="rooms" class="list-group"></ul>
  </div>
  <div class="col-6">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span id="room-title">Select a room</span>
        <small id="meta" class="text-muted"></small>
      </div>
      <div id="chat" class="card-body" style="height:360px; overflow:auto;"></div>
      <div class="card-footer">
        <form id="msg-form" class="d-flex gap-2">
          <input id="msg-input" class="form-control" type="text" placeholder="Type a message..." />
          <button class="btn btn-primary" type="submit">Send</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-3">
    <h5 class="mb-3">Members</h5>
    <ul id="members" class="list-group"></ul>
  </div>
</div>

{% endblock %}
{% block scripts %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  $(function(){
    const $rooms = $('#rooms');
    const $chat = $('#chat');
    const $meta = $('#meta');
    const $form = $('#msg-form');
    const $input = $('#msg-input');
    const $title = $('#room-title');
    const $members = $('#members');
    let currentRoomId = null;
    let socket = null;
    let onlineUserIds = new Set(); // Track online user IDs
    let currentUserId = null; // Track current user ID

    function getAvatarHtml(imageUrl, size = 40){
      if(imageUrl){
        return `<img src="/auth/uploads/${imageUrl}" style="width:${size}px; height:${size}px; border-radius:50%; object-fit:cover; border:2px solid #dee2e6;" />`;
      } else {
        return `<div style="width:${size}px; height:${size}px; border-radius:50%; background:#f8f9fa; border:2px solid #dee2e6; display:flex; align-items:center; justify-content:center;"><i class="fas fa-user text-muted"></i></div>`;
      }
    }

    function appendMessage(msgObj){
      const isOwn = msgObj.user_id === currentUserId;
      const $msgContainer = $('<div/>').addClass('d-flex mb-3').css({
        'justify-content': isOwn ? 'flex-end' : 'flex-start',
        'align-items': 'flex-end'
      });
      
      if(!isOwn){
        const $avatar = $('<div/>').css({'margin-right': '8px'});
        $avatar.html(getAvatarHtml(msgObj.author_image));
        $msgContainer.append($avatar);
      }
      
      const $msgBubble = $('<div/>').addClass('px-3 py-2 rounded').css({
        'max-width': '50%',
        'background': isOwn ? '#d4edda' : '#ffffff',
        'color': isOwn ? '#000' : '#212529',
        'border': isOwn ? '1px solid #c3e6cb' : '1px solid #dee2e6',
        'box-shadow': '0 1px 2px rgba(0,0,0,0.1)'
      });
      $msgBubble.append($('<div/>').text(msgObj.content));
      $msgContainer.append($msgBubble);
      
      if(isOwn){
        const $avatar = $('<div/>').css({'margin-left': '8px'});
        $avatar.html(getAvatarHtml(msgObj.author_image));
        $msgContainer.append($avatar);
      }
      
      $chat.append($msgContainer);
      $chat.scrollTop($chat[0].scrollHeight);
    }

    function append(msg){
      const $div = $('<div/>').text(msg);
      $chat.append($div);
      $chat.scrollTop($chat[0].scrollHeight);
    }

    async function fetchJSON(url, opts){
      const res = await fetch(url, Object.assign({headers:{'Content-Type':'application/json'}}, opts));
      if(!res.ok) throw new Error('Request failed');
      return await res.json();
    }

    function maskEmail(email){
      if(!email) return '';
      const parts = email.split('@');
      if(parts.length !== 2) return email;
      const local = parts[0];
      return local + '@*****';
    }

    async function loadMembers(){
      try {
        const list = await fetchJSON('/members');
        renderMembers(list);
      } catch(e){
        // Silently fail if not logged in
      }
    }

    function renderMembers(list){
      $members.empty();
      list.forEach(m => {
        const $li = $('<li/>').addClass('list-group-item d-flex align-items-center');
        const isOnline = m.online || onlineUserIds.has(m.id);
        if(isOnline){
          const $dot = $('<span/>').css({
            'width': '10px',
            'height': '10px',
            'background': '#28a745',
            'border-radius': '50%',
            'display': 'inline-block',
            'margin-right': '8px'
          });
          $li.append($dot);
        }
        const $avatar = $('<div/>').css({'margin-right': '8px'});
        $avatar.html(getAvatarHtml(m.image, 32));
        $li.append($avatar);
        const displayText = m.name ? `${m.name} (${maskEmail(m.email)})` : maskEmail(m.email);
        $li.append($('<span/>').text(displayText));
        $members.append($li);
      });
    }

    async function loadRooms(){
      try {
        const list = await fetchJSON('/rooms');
        $rooms.empty();
        list.forEach(r => {
          const $li = $('<li/>').addClass('list-group-item d-flex justify-content-between align-items-center');
          const $a = $('<a/>').attr('href', '#').text(r.name);
          $a.on('click', async (e) => {
            e.preventDefault();
            await fetchJSON(`/rooms/${r.id}/join`, {method:'POST'});
            joinSocketRoom(r.id);
            loadMessages(r.id);
            $title.text(r.name);
          });
          $li.append($a);
          $rooms.append($li);
        });
      } catch(e){
        $meta.text('Load rooms failed (login required).');
      }
    }

    async function loadMessages(roomId){
      const msgs = await fetchJSON(`/rooms/${roomId}/messages?limit=50`);
      $chat.empty();
      msgs.forEach(m => appendMessage(m));
    }

    function ensureSocket(){
      if(socket) return;
      socket = io('/chat');
      socket.on('ready', (data)=>{ 
        currentUserId = data.user_id;
        $meta.text(`Connected as ${data.user_id} (${data.role})`);
        // Reload members to get online status
        loadMembers();
      });
      socket.on('online_users', (data)=>{
        // Update online users set
        onlineUserIds.clear();
        if(data.users){
          data.users.forEach(u => onlineUserIds.add(u.id));
        }
        loadMembers();
      });
      socket.on('user_online', (data)=>{
        onlineUserIds.add(data.user_id);
        loadMembers();
      });
      socket.on('user_offline', (data)=>{
        onlineUserIds.delete(data.user_id);
        loadMembers();
      });
      socket.on('new_message', (m)=>{ 
        if(String(m.room_id) === String(currentRoomId)) {
          appendMessage(m);
        }
      });
      socket.on('room_deleted', (data)=>{
        if(String(data.room_id) === String(currentRoomId)){
          append('Room was deleted by admin.');
          currentRoomId = null;
          $title.text('Select a room');
        }
        // Refresh rooms list
        loadRooms();
      });
    }

    function joinSocketRoom(roomId){
      ensureSocket();
      currentRoomId = roomId;
      socket.emit('join_room', {room_id: roomId});
    }

    $form.on('submit', (e)=>{
      e.preventDefault();
      const text = ($input.val() || '').trim();
      if(!text || !currentRoomId) return;
      socket.emit('send_message', {room_id: currentRoomId, content: text});
      $input.val('');
    });

    loadRooms();
    loadMembers();
    // Auto-connect Socket.IO if logged in to track online status
    ensureSocket();
    // Get current user ID from auth endpoint
    (async function(){
      try {
        const res = await fetch('/auth/me');
        const data = await res.json();
        if(data.authenticated && data.user){
          currentUserId = data.user.id;
        }
      } catch(e){
        // Silently fail
      }
    })();
  });
</script>
{% endblock %}


