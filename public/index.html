{% extends "app.html" %}
{% block title %}Chat â€“ Home{% endblock %}
{% block content %}
<style>
  body {
    overflow: hidden;
  }
  
  #chat-input-fixed {
    position: fixed;
    bottom: 0;
    z-index: 1000;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    background-color: #fff;
    border-top: 1px solid rgba(0,0,0,.125);
  }
  
  #chat-input-container {
    padding: 0.5rem;
  }
  
  /* Hide footer on main page */
  footer {
    display: none;
  }
  
  /* Adjust main content to account for fixed input */
  main {
    padding-bottom: 70px !important;
    height: calc(100vh - 56px);
    max-height: calc(100vh - 56px);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .mobile-chat-row {
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }
  
  @media (max-width: 767.98px) {
    #chat-input-fixed {
      left: 0;
      right: 0;
    }
    #chat-input-container {
      padding: 0.5rem 15px;
    }
    .mobile-chat-row {
      display: flex;
      flex-direction: column;
      margin-top: 0 !important;
      gap: 0.5rem !important;
      flex-grow: 1 !important;
      height: auto !important;
      overflow: visible !important;
      --bs-gutter-x: 0;
      --bs-gutter-y: 0.75rem;
    }
    #chat-container {
      flex: 1;
      min-height: 0;
      margin-top: 0;
      display: flex;
      flex-direction: column;
    }
    #chat-container .card {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      min-height: 0;
    }
    main {
      padding-bottom: 70px !important;
      height: calc(100vh - 56px);
      max-height: calc(100vh - 56px);
      overflow-y: auto;
      overflow-x: hidden;
    }
    .mobile-chat-row {
      overflow: visible;
    }
  }
  
  @media (min-width: 768px) {
    #chat-input-fixed {
      display: none !important;
    }
    #chat-input-desktop {
      margin-top: auto;
    }
    .mobile-chat-row {
      height: 100%;
      min-height: 0;
      align-items: stretch;
      --bs-gutter-x: 0;
      --bs-gutter-y: 0;
    }
    .mobile-chat-row > .col-md-3,
    .mobile-chat-row > .col-md-6 {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .mobile-chat-row > .col-md-3 {
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 0.75rem;
    }
    .mobile-chat-row > .col-md-6 {
      min-height: 0;
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }
    #chat-container {
      height: 100%;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }
    #chat-container .card {
      height: 100%;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
      max-height: 100%;
    }
    #chat-container .card-header {
      flex-shrink: 0;
      height: auto;
    }
    #chat {
      flex: 1 1 auto;
      overflow-y: auto;
      overflow-x: hidden;
      min-height: 0;
      max-height: calc(100% - 75px);
    }
    #chat-input-desktop {
      flex: 0 0 auto;
      padding: 0.75rem;
      border-top: 1px solid rgba(0,0,0,.125);
      height: auto;
      min-height: fit-content;
      margin-top: auto;
    }
    #chat-input-desktop form {
      margin: 0;
      width: 100%;
    }
    main {
      padding-bottom: 10px !important;
      height: calc(100vh - 56px);
      max-height: calc(100vh - 56px);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .mobile-chat-row {
      flex: 1;
      min-height: 0;
      height: 100%;
      max-height: 100%;
    }
  }
</style>
<div class="row flex-grow-1 mobile-chat-row">
  <!-- Desktop: Left sidebar for rooms -->
  <div class="col-md-3 d-none d-md-block">
    <h5 class="mb-3">Rooms</h5>
    <div class="mb-2">
      <button class="btn btn-sm btn-primary w-100" data-bs-toggle="collapse" data-bs-target="#create-room-form">
        <i class="fas fa-plus"></i> Create Room
      </button>
      <div class="collapse mt-2" id="create-room-form">
        <div class="card card-body">
          <input type="text" id="new-room-name" class="form-control form-control-sm mb-2" placeholder="Room name" />
          <button class="btn btn-sm btn-success w-100" id="create-room-btn">Create</button>
        </div>
      </div>
    </div>
    <ul id="rooms" class="list-group"></ul>
  </div>
  
  <!-- Mobile: Room dropdown and members button -->
  <div class="col-12 d-md-none mb-1">
    <div class="mb-1">
      <select id="room-select-mobile" class="form-select">
        <option value="">Select a room</option>
      </select>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-primary flex-grow-1" data-bs-toggle="collapse" data-bs-target="#create-room-form-mobile">
        <i class="fas fa-plus"></i> Create Room
      </button>
      <button class="btn btn-sm btn-info" data-bs-toggle="offcanvas" data-bs-target="#members-offcanvas">
        <i class="fas fa-users"></i> Members
      </button>
    </div>
    <div class="collapse mt-1" id="create-room-form-mobile">
      <div class="card card-body">
        <input type="text" id="new-room-name-mobile" class="form-control form-control-sm mb-2" placeholder="Room name" />
        <button class="btn btn-sm btn-success w-100" id="create-room-btn-mobile">Create</button>
      </div>
    </div>
  </div>
  
  <!-- Chat area -->
  <div class="col-md-6 col-12 d-flex flex-column" id="chat-container">
    <div class="card d-flex flex-column">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span id="room-title">Select a room</span>
        <small id="meta" class="text-muted"></small>
      </div>
      <div id="chat" class="card-body flex-grow-1" style="overflow:auto; min-height:0;"></div>
      <!-- Desktop: Input inside card footer -->
      <div class="card-footer d-none d-md-block" id="chat-input-desktop">
        <form id="msg-form-desktop" class="d-flex gap-2">
          <input id="msg-input-desktop" class="form-control" type="text" placeholder="Type a message..." />
          <button class="btn btn-primary" type="submit">Send</button>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Fixed chat input at bottom (Mobile only) -->
  <div id="chat-input-fixed" class="d-md-none">
    <div id="chat-input-container">
      <form id="msg-form" class="d-flex gap-2">
        <input id="msg-input" class="form-control" type="text" placeholder="Type a message..." />
        <button class="btn btn-primary" type="submit">Send</button>
      </form>
    </div>
  </div>
  
  <!-- Desktop: Right sidebar for members -->
  <div class="col-md-3 d-none d-md-block">
    <h5 class="mb-3">Members</h5>
    <ul id="members" class="list-group"></ul>
  </div>
  
  <!-- Mobile: Members offcanvas -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="members-offcanvas">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Members</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <ul id="members-mobile" class="list-group"></ul>
    </div>
  </div>
</div>

{% endblock %}
{% block scripts %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  $(function(){
    const $rooms = $('#rooms');
    const $chat = $('#chat');
    const $meta = $('#meta');
    const $form = $('#msg-form');
    const $input = $('#msg-input');
    const $formDesktop = $('#msg-form-desktop');
    const $inputDesktop = $('#msg-input-desktop');
    const $title = $('#room-title');
    
    // Unified function to send message
    function sendMessage(text){
      if(!text || !currentRoomId) return;
      socket.emit('send_message', {room_id: currentRoomId, content: text});
      $input.val('');
      $inputDesktop.val('');
    }
    const $members = $('#members');
    const $membersMobile = $('#members-mobile');
    const $roomSelectMobile = $('#room-select-mobile');
    const $roomsContainer = $('.col-md-3.d-none.d-md-block'); // Rooms sidebar container
    let currentRoomId = null;
    let socket = null;
    let onlineUserIds = new Set(); // Track online user IDs
    let currentUserId = null; // Track current user ID
    let roomsData = []; // Store rooms data

    function getAvatarHtml(imageUrl, size = 40){
      if(imageUrl){
        return `<img src="/auth/uploads/${imageUrl}" style="width:${size}px; height:${size}px; border-radius:50%; object-fit:cover; border:2px solid #dee2e6;" />`;
      } else {
        return `<div style="width:${size}px; height:${size}px; border-radius:50%; background:#f8f9fa; border:2px solid #dee2e6; display:flex; align-items:center; justify-content:center;"><i class="fas fa-user text-muted"></i></div>`;
      }
    }

    // Change room sidebar background to light blue when room is selected
    function changeRoomBackground(roomId){
      if(roomId){
        // Light blue background color for rooms sidebar
        $roomsContainer.css('background-color', '#e7f3ff');
      } else {
        // Default white background when no room selected
        $roomsContainer.css('background-color', '#ffffff');
      }
    }

    function appendMessage(msgObj){
      const isOwn = msgObj.user_id === currentUserId;
      const $msgContainer = $('<div/>').addClass('d-flex mb-3').css({
        'justify-content': isOwn ? 'flex-end' : 'flex-start',
        'align-items': 'flex-end'
      });
      
      if(!isOwn){
        const $avatar = $('<div/>').css({'margin-right': '8px'});
        $avatar.html(getAvatarHtml(msgObj.author_image));
        $msgContainer.append($avatar);
      }
      
      const $msgBubble = $('<div/>').addClass('px-3 py-2 rounded').css({
        'max-width': '50%',
        'background': isOwn ? '#d4edda' : '#ffffff',
        'color': isOwn ? '#000' : '#212529',
        'border': isOwn ? '1px solid #c3e6cb' : '1px solid #dee2e6',
        'box-shadow': '0 1px 2px rgba(0,0,0,0.1)'
      });
      $msgBubble.append($('<div/>').text(msgObj.content));
      $msgContainer.append($msgBubble);
      
      if(isOwn){
        const $avatar = $('<div/>').css({'margin-left': '8px'});
        $avatar.html(getAvatarHtml(msgObj.author_image));
        $msgContainer.append($avatar);
      }
      
      $chat.append($msgContainer);
      $chat.scrollTop($chat[0].scrollHeight);
    }

    function append(msg){
      const $div = $('<div/>').text(msg);
      $chat.append($div);
      $chat.scrollTop($chat[0].scrollHeight);
    }

    async function fetchJSON(url, opts){
      const res = await fetch(url, Object.assign({headers:{'Content-Type':'application/json'}}, opts));
      if(!res.ok) throw new Error('Request failed');
      return await res.json();
    }

    function maskEmail(email){
      if(!email) return '';
      const parts = email.split('@');
      if(parts.length !== 2) return email;
      const local = parts[0];
      return local + '@*****';
    }

    async function loadMembers(){
      try {
        const list = await fetchJSON('/members');
        renderMembers(list);
      } catch(e){
        // Silently fail if not logged in
      }
    }

    function renderMembers(list){
      $members.empty();
      $membersMobile.empty();
      list.forEach(m => {
        const $li = $('<li/>').addClass('list-group-item d-flex align-items-center');
        const isOnline = m.online || onlineUserIds.has(m.id);
        if(isOnline){
          const $dot = $('<span/>').css({
            'width': '10px',
            'height': '10px',
            'background': '#28a745',
            'border-radius': '50%',
            'display': 'inline-block',
            'margin-right': '8px'
          });
          $li.append($dot);
        }
        const $avatar = $('<div/>').css({'margin-right': '8px'});
        $avatar.html(getAvatarHtml(m.image, 32));
        $li.append($avatar);
        const displayText = m.name ? `${m.name} (${maskEmail(m.email)})` : maskEmail(m.email);
        $li.append($('<span/>').text(displayText));
        $members.append($li.clone());
        $membersMobile.append($li);
      });
    }

    async function loadRooms(){
      try {
        const list = await fetchJSON('/rooms');
        roomsData = list;
        $rooms.empty();
        $roomSelectMobile.empty().append('<option value="">Select a room</option>');
        
        list.forEach(r => {
          const $li = $('<li/>').addClass('list-group-item d-flex justify-content-between align-items-center');
          const $left = $('<div/>').addClass('d-flex align-items-center flex-grow-1');
          const $a = $('<a/>').attr('href', '#').text(r.name).css({'text-decoration':'none', 'flex-grow':'1'});
          $a.on('click', async (e) => {
            e.preventDefault();
            await fetchJSON(`/rooms/${r.id}/join`, {method:'POST'});
            joinSocketRoom(r.id);
            loadMessages(r.id);
            $title.text(r.name);
            currentRoomId = r.id;
            $roomSelectMobile.val(r.id);
            changeRoomBackground(r.id);
          });
          $left.append($a);
          
          // Show management buttons only if user is a member of the room
          if(currentUserId && r.is_member){
            const $btns = $('<div/>').addClass('btn-group btn-group-sm ms-2');
            const $closeBtn = $('<button/>').addClass('btn btn-outline-warning btn-sm').html('<i class="fas fa-lock"></i>');
            $closeBtn.on('click', async (e)=>{
              e.stopPropagation();
              if(confirm('Are you sure you want to close this room?')){
                await fetchJSON(`/rooms/${r.id}/close`, {method:'POST'});
                loadRooms();
              }
            });
            const $delBtn = $('<button/>').addClass('btn btn-outline-danger btn-sm').html('<i class="fas fa-trash"></i>');
            $delBtn.on('click', async (e)=>{
              e.stopPropagation();
              if(confirm('Are you sure you want to delete this room?')){
                await fetchJSON(`/rooms/${r.id}`, {method:'DELETE'});
                loadRooms();
              }
            });
            $btns.append($closeBtn).append($delBtn);
            $left.append($btns);
          }
          
          $li.append($left);
          $rooms.append($li);
          
          // Add to mobile dropdown
          const $option = $('<option/>').val(r.id).text(r.name);
          if(r.id === currentRoomId){
            $option.prop('selected', true);
          }
          $roomSelectMobile.append($option);
        });
        // Apply background color if a room is already selected
        if(currentRoomId){
          changeRoomBackground(currentRoomId);
        } else {
          changeRoomBackground(null);
        }
        // Update input position after layout changes
        setTimeout(function(){
          positionChatInput();
          adjustMobileChatHeight();
        }, 50);
        setTimeout(function(){
          positionChatInput();
          adjustMobileChatHeight();
        }, 200);
      } catch(e){
        $meta.text('Load rooms failed (login required).');
      }
    }

    async function loadMessages(roomId){
      const msgs = await fetchJSON(`/rooms/${roomId}/messages?limit=50`);
      $chat.empty();
      msgs.forEach(m => appendMessage(m));
    }

    function ensureSocket(){
      if(socket) return;
      socket = io('/chat');
      socket.on('ready', (data)=>{ 
        currentUserId = data.user_id;
        $meta.text(`Connected as ${data.user_id} (${data.role})`);
        // Reload members to get online status
        loadMembers();
      });
      socket.on('online_users', (data)=>{
        // Update online users set
        onlineUserIds.clear();
        if(data.users){
          data.users.forEach(u => onlineUserIds.add(u.id));
        }
        loadMembers();
      });
      socket.on('user_online', (data)=>{
        onlineUserIds.add(data.user_id);
        loadMembers();
      });
      socket.on('user_offline', (data)=>{
        onlineUserIds.delete(data.user_id);
        loadMembers();
      });
      socket.on('new_message', (m)=>{ 
        if(String(m.room_id) === String(currentRoomId)) {
          appendMessage(m);
        }
      });
      socket.on('room_deleted', (data)=>{
        if(String(data.room_id) === String(currentRoomId)){
          append('Room was deleted.');
          currentRoomId = null;
          $title.text('Select a room');
          changeRoomBackground(null);
        }
        // Refresh rooms list
        loadRooms();
      });
      socket.on('room_closed', (data)=>{
        if(String(data.room_id) === String(currentRoomId)){
          append('Room was closed.');
          currentRoomId = null;
          $title.text('Select a room');
          changeRoomBackground(null);
        }
        // Refresh rooms list
        loadRooms();
      });
    }

    function joinSocketRoom(roomId){
      ensureSocket();
      currentRoomId = roomId;
      socket.emit('join_room', {room_id: roomId});
    }

    // Mobile form submit
    $form.on('submit', (e)=>{
      e.preventDefault();
      const text = ($input.val() || '').trim();
      sendMessage(text);
    });
    
    // Desktop form submit
    $formDesktop.on('submit', (e)=>{
      e.preventDefault();
      const text = ($inputDesktop.val() || '').trim();
      sendMessage(text);
    });

    loadRooms();
    loadMembers();
    // Auto-connect Socket.IO if logged in to track online status
    ensureSocket();
    // Get current user ID from auth endpoint
    (async function(){
      try {
        const res = await fetch('/auth/me');
        const data = await res.json();
        if(data.authenticated && data.user){
          currentUserId = data.user.id;
          loadRooms(); // Reload rooms to show management buttons
        }
      } catch(e){
        // Silently fail
      }
    })();
    
    // Create room handler (desktop)
    $('#create-room-btn').on('click', async function(){
      const name = $('#new-room-name').val();
      if(!name || !name.trim()){
        alert('Please enter a room name');
        return;
      }
      try {
        const res = await fetch('/rooms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({name: name.trim()})
        });
        const data = await res.json();
        if(res.ok){
          $('#new-room-name').val('');
          $('#create-room-form').collapse('hide');
          loadRooms();
        } else {
          alert(data.error || 'Failed to create room');
        }
      } catch(e){
        alert('Failed to create room, please try again');
      }
    });
    
    // Create room handler (mobile)
    $('#create-room-btn-mobile').on('click', async function(){
      const name = $('#new-room-name-mobile').val();
      if(!name || !name.trim()){
        alert('Please enter a room name');
        return;
      }
      try {
        const res = await fetch('/rooms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({name: name.trim()})
        });
        const data = await res.json();
        if(res.ok){
          $('#new-room-name-mobile').val('');
          $('#create-room-form-mobile').collapse('hide');
          loadRooms();
        } else {
          alert(data.error || 'Failed to create room');
        }
      } catch(e){
        alert('Failed to create room, please try again');
      }
    });
    
    // Mobile room select handler
    $roomSelectMobile.on('change', async function(){
      const roomId = $(this).val();
      if(roomId){
        const room = roomsData.find(r => r.id == roomId);
        if(room){
          await fetchJSON(`/rooms/${roomId}/join`, {method:'POST'});
          joinSocketRoom(roomId);
          loadMessages(roomId);
          $title.text(room.name);
          currentRoomId = roomId;
          changeRoomBackground(roomId);
        }
      } else {
        // Reset to default when no room selected
        changeRoomBackground(null);
      }
    });
    
    let resizeTimer = null;
    
    // Position chat input for mobile (desktop input is inside card)
    function positionChatInput(){
      if(window.innerWidth < 768){
        const $inputFixed = $('#chat-input-fixed');
        if($inputFixed.length){
          $inputFixed.css({
            left: '0',
            right: '0',
            width: '100%'
          });
        }
      }
    }
    
    // Calculate mobile chat container height dynamically
    function adjustMobileChatHeight(){
      if(window.innerWidth < 768){
        const $topControls = $('.d-md-none.mb-1');
        const $chatContainer = $('#chat-container');
        const $inputFixed = $('#chat-input-fixed');
        if($topControls.length && $chatContainer.length && $inputFixed.length){
          const topControlsHeight = $topControls.outerHeight(true) || 0;
          const inputHeight = $inputFixed.outerHeight(true) || 0;
          const navbarHeight = 56; // navbar height
          const availableHeight = window.innerHeight - navbarHeight - topControlsHeight - inputHeight - 20; // 20px for margins
          $chatContainer.css({
            height: availableHeight + 'px',
            maxHeight: availableHeight + 'px'
          });
        }
      } else {
        // Desktop: reset mobile height styles
        const $chatContainer = $('#chat-container');
        if($chatContainer.length){
          $chatContainer.css({
            height: '',
            maxHeight: ''
          });
        }
      }
    }
    
    // Debounced resize handler
    function handleResize(){
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(function(){
        positionChatInput();
        adjustMobileChatHeight();
      }, 150);
    }
    
    $(window).on('resize', handleResize);
    $(window).on('orientationchange', function(){
      setTimeout(function(){
        positionChatInput();
        adjustMobileChatHeight();
      }, 300);
    });
    
    // Initial positioning
    positionChatInput();
    adjustMobileChatHeight();
    
    // Multiple attempts to ensure correct positioning
    setTimeout(function(){
      positionChatInput();
      adjustMobileChatHeight();
    }, 100);
    setTimeout(function(){
      positionChatInput();
      adjustMobileChatHeight();
    }, 300);
    setTimeout(function(){
      positionChatInput();
      adjustMobileChatHeight();
    }, 800);
  });
</script>
{% endblock %}


